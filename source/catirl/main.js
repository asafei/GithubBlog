!function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);let i={test_vsSource:"#version 300 es\n\nin vec2 a_position;\nin vec4 a_color;\n\nuniform mat3 u_matrix;\n\nout vec4 v_color;\n\nvoid main() {\n  // Multiply the position by the matrix.\n  gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n\n  // Copy the color from the attribute to the varying.\n  v_color = a_color;\n}",test_fsSource:"#version 300 es\n\nprecision mediump float;\n\nin vec4 v_color;\n\nout vec4 outColor;\n\nvoid main() {\n  outColor = v_color;\n}",point_vs:"#version 300 es\n#define POINT_SIZE_DEFAULT 5.0;\n\nin vec3 a_position;\nout vec4 v_color;\nuniform mat4 u_vpmatrix;\n\n\nvoid main() {\n  gl_Position = u_vpmatrix*vec4(a_position.xyz, 1);\n \n\n  //判断是否预定义了点默认大小，如果定义了则使用\n  #if defined(POINT_SIZE_DEFAULT)\n  \tgl_PointSize=POINT_SIZE_DEFAULT;\n  #endif\n  \n  v_color = vec4(gl_Position);\n}",point_fs:"#version 300 es\nprecision mediump float;\nin vec4 v_color;\nout vec4 outColor;\n\nvoid main() {\n  outColor = v_color;\n\n}",base_vs:"#version 300 es\n#define POINT_SIZE_DEFAULT 2.0;\n#define EARTH_RADIUS 6378137.0;\n\nin vec3 a_position;\nout vec4 v_color;\n\n//将经纬度转化为笛卡尔坐标\nvec3 wgs84ToCartesian(vec3 coord){\n\tfloat R=EARTH_RADIUS+coord.z;//define的变量，可判断，也可以不判断直接使用\n\tfloat x=R*cos(radians(latitude))*cos(radians(longitude));\n\tfloat y=R*cos(radians(latitude))*sin(radians(longitude));\n\tfloat z=R*sin(radians(latitude));\n\treturn vec3(x,y,z);\n}\n\nvoid main() {\n\n  gl_Position = vec4(wgs84ToCartesian(a_position.xyz), 1);\n  //判断是否预定义了点默认大小，如果定义了则使用\n  #if defined(POINT_SIZE_DEFAULT)\n  \tgl_PointSize=POINT_SIZE_DEFAULT;\n  #endif\n  \n  v_color = vec4(gl_Position);\n}",img_vs:"#version 300 es\n#define POINT_SIZE_DEFAULT 5.0;\n#define EARTH_RADIUS 1000.0;\n\nin vec3 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\nuniform mat4 u_vpmatrix;\n\n//将经纬度转化为笛卡尔坐标\nvec3 wgs84ToCartesian(vec3 coord){\n  float R=EARTH_RADIUS+coord.z;//define的变量，可判断，也可以不判断直接使用\n  float x=R*cos(radians(coord.y))*cos(radians(coord.x));\n  float y=R*cos(radians(coord.y))*sin(radians(coord.x));\n  float z=R*sin(radians(coord.y));\n  return vec3(x,y,z);\n  // return coord;\n}\n\nvoid main() {\n  vec3 position=wgs84ToCartesian(a_position);\n  gl_Position = u_vpmatrix*vec4(position.xyz, 1);\n  v_texcoord=a_texcoord;\n}",img_fs:"#version 300 es\nprecision mediump float;\nin vec2 v_texcoord;\nuniform sampler2D u_texture;\nout vec4 outColor;\n\nvoid main(){\n\toutColor = texture(u_texture, v_texcoord);\n\toutColor.r=1.0;\n}\n"};var n=i;const a=6378137;var o=class{constructor(){this.R=a,this.MAX_LATITUDE=85.0511287798}static project(t){this.R=a,this.MAX_LATITUDE=85.0511287798;let e=Math.PI/180,r=this.MAX_LATITUDE,i=Math.max(Math.min(r,t[1]),-r),n=Math.sin(i*e);return[this.R*t[0]*e,this.R*Math.log((1+n)/(1-n))/2]}static unProject(t){this.R=a;const e=180/Math.PI,r=(2*Math.atan(Math.exp(t[1]/this.R))-Math.PI/2)*e;return[t[0]*e/this.R,r]}};var s=class{static createShader(t,e,r){const i=t.createShader(r);if(t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS))return i;console.warn(t.getShaderInfoLog(i)),t.deleteShader(i)}static createProgram(t,e,r){const i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,r),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS))return i;console.warn(t.getProgramInfoLog(i)),t.deleteProgram(i)}static createProgramFromSources(t,e,r){const i=this.createShader(t,e,t.VERTEX_SHADER),n=this.createShader(t,r,t.FRAGMENT_SHADER);return this.createProgram(t,i,n)}static resizeCanvasToDisplaySize(t,e=1){const r=t.clientWidth*e|0,i=t.clientHeight*e|0;return(t.width!==r||t.height!==i)&&(t.width=r,t.height=i,!0)}static radToDeg(t){return 180*t/Math.PI}static degToRad(t){return t*Math.PI/180}lonLatToMercator(t,e){}mercatorToLonLat(t,e){}static lonLatToSphericalMercator(t,e){return o.project(t)}static sphericalMercatorToLonLat(t){return o.unProject(t)}static getTileInfo(t,e,r,i,n,a){const o=[(e-t)/a,(r-i)/n],s=[],c=[],h=[];for(let e=0;e<=n;e++){const i=r-e*o[1],h=0+e/n;for(let e=0;e<=a;e++)s.push(t+e*o[0],i,0),c.push(e/a,h)}for(let t=0;t<n;t++){const e=t*(a+1),r=(t+1)*(a+1);for(let t=0;t<a;t++)h.push(e+t,r+t+1,e+t+1),h.push(e+t,r+t,r+t+1)}return{a_position:s,a_texcoord:c,index:h}}static throttle(t,e,r){let i,n,a,o;return o=function(){i=!1,n&&(a.apply(r,n),n=!1)},a=function(){i?n=arguments:(t.apply(r,arguments),setTimeout(o,e),i=!0)},a}};var c=class{constructor(t){this.gl=t}createBufferData(t,e,r){const i=this.gl,n=this.bindBufferData(this.createBuffer(),r.bufferType,t,e);return"index"!==r.name&&(i.enableVertexAttribArray(r.location),i.vertexAttribPointer(r.location,r.size,r.dataType,r.normalize,r.stride,r.offset)),n}createBuffer(){return this.gl.createBuffer()}bindBufferData(t,e,r,i){const n=this.gl;return n.bindBuffer(e,t),n.bufferData(e,r,i),t}createVAOInfo(){return{vao:this.gl.createVertexArray(),count:0,indexCount:0,offset:0}}bindVertexArrayData(t,e){const r=this.gl;r.bindVertexArray(t);for(let{location:t,size:i,dataType:n,normalize:a,stride:o,offset:s}of e)r.enableVertexAttribArray(t),r.vertexAttribPointer(t,i,n,a,o,s);return r.bindVertexArray(null),{vao:t,offset:0,count:0}}createTextureInfo(t){const e=this.gl,r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const i={width:1,height:1,texture:r,update:!1},n=new Image;return n.crossOrigin="",n.addEventListener("load",(function(){i.update=!0,i.width=n.width,i.height=n.height,e.bindTexture(e.TEXTURE_2D,i.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.generateMipmap(e.TEXTURE_2D)})),n.src=t,i}requestCORSIfNotSameOrigin(t,e){new URL(e).origin!==window.location.origin&&(t.crossOrigin="")}createTextureData(t){const e=this.gl,r=e.createTexture();return console.log("texture",r),e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),r}};var h=class extends c{constructor(t){super(t),this.program=s.createProgramFromSources(this.gl,n.img_vs,n.img_fs);const e=this.gl.getAttribLocation(this.program,"a_position"),r=this.gl.getAttribLocation(this.program,"a_texcoord"),i=this.gl.getUniformLocation(this.program,"u_vpmatrix"),a=this.gl.getUniformLocation(this.program,"u_texture");this.attributes=[{name:"a_position",type:"vec3",bufferType:this.gl.ARRAY_BUFFER,location:e,arrayType:Float32Array,size:3,dataType:this.gl.FLOAT,stride:0,offset:0,normalize:!1},{name:"a_texcoord",type:"vec2",bufferType:this.gl.ARRAY_BUFFER,location:r,arrayType:Float32Array,size:2,dataType:this.gl.FLOAT,stride:0,offset:0,normalize:!1},{name:"index",arrayType:Uint32Array,bufferType:this.gl.ELEMENT_ARRAY_BUFFER}],this.uniforms=[{name:"u_vpmatrix",type:"mat4",functionType:"uniformMatrix4fv",location:i,normalize:!1,data:null},{name:"u_texture",type:"mat4",functionType:"uniform1i",location:a,normalize:!1,data:0}]}};var l=class{constructor(t){this.EARTH_RADIUS=6378137,this.RADIUS=1e3,this.SCALE_FACTOR=this.RADIUS/this.EARTH_RADIUS,this.MIN_LEVEL=0,this.MAX_LEVEL=25,this.baseLevel=6,this.GRID_COL=64,this.GRID_RAW=64,this.crs=null,this.imageUrl=t}setMap(t){this.map=t,this.gl=t.gl,this.program=new h(this.gl),this.init()}init(){const t=s.getTileInfo(-180,180,85.0511287798,-85.0511287798,this.GRID_RAW,this.GRID_COL);this.vaoInfo=this.program.createVAOInfo(),this.gl.bindVertexArray(this.vaoInfo.vao),this.program.attributes.forEach(e=>{this.program.createBufferData(new e.arrayType(t[e.name]),this.gl.STATIC_DRAW,e)});const e=this.program.createTextureInfo(this.imageUrl);this.gl.bindVertexArray(null),this.vaoInfo.count=t.a_position.length/3,this.vaoInfo.indexCount=t.index.length,this.textureInfo=e}redraw(){const t=this.gl;if(t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.useProgram(this.program.program),this.program.uniforms[0].data=this.map.camera.getViewProjectionMatrix(),this.program.uniforms.forEach(e=>{t[e.functionType](e.location,e.normalize,e.data)}),t.bindVertexArray(this.vaoInfo.vao),this.textureInfo.update){const e=this.program.uniforms[1].location,r=0;t.uniform1i(e,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,this.textureInfo.texture),this.textureInfo.update=!1}t.drawElements(t.TRIANGLES,this.vaoInfo.indexCount,t.UNSIGNED_INT,this.vaoInfo.offset),t.bindVertexArray(null),t.useProgram(null)}getPointIndices(t,e){const r=[];for(let i=0;i<=t;i++)for(let n=0;n<=e;n++)r.push(i*(t+1)+n);return r}getModelMatrix(){}wgs84ToCartesian(t,e,r=0){const i=this.RADIUS+r*this.SCALE_FACTOR,n=i*this.roundNum(Math.sin(2*Math.PI*e/360));return[i*this.roundNum(Math.cos(2*Math.PI*e/360))*this.roundNum(Math.cos(2*Math.PI*t/360)),i*this.roundNum(Math.cos(2*Math.PI*e/360))*this.roundNum(Math.sin(2*Math.PI*t/360)),n]}roundNum(t){return 1*t.toFixed(5)}cartesianToWgs84(t,e,r){}mercatorToCartesian(t,e,r){}cartesianToMercator(t,e,r){}};var u=class{constructor(){}};class d{static multiply(t,e,r){r=r||new Float32Array(16);var i=e[0],n=e[1],a=e[2],o=e[3],s=e[4],c=e[5],h=e[6],l=e[7],u=e[8],d=e[9],v=e[10],p=e[11],m=e[12],g=e[13],f=e[14],E=e[15],T=t[0],_=t[1],y=t[2],x=t[3],M=t[4],w=t[5],A=t[6],R=t[7],I=t[8],S=t[9],D=t[10],L=t[11],P=t[12],b=t[13],C=t[14],U=t[15];return r[0]=i*T+n*M+a*I+o*P,r[1]=i*_+n*w+a*S+o*b,r[2]=i*y+n*A+a*D+o*C,r[3]=i*x+n*R+a*L+o*U,r[4]=s*T+c*M+h*I+l*P,r[5]=s*_+c*w+h*S+l*b,r[6]=s*y+c*A+h*D+l*C,r[7]=s*x+c*R+h*L+l*U,r[8]=u*T+d*M+v*I+p*P,r[9]=u*_+d*w+v*S+p*b,r[10]=u*y+d*A+v*D+p*C,r[11]=u*x+d*R+v*L+p*U,r[12]=m*T+g*M+f*I+E*P,r[13]=m*_+g*w+f*S+E*b,r[14]=m*y+g*A+f*D+E*C,r[15]=m*x+g*R+f*L+E*U,r}static addVectors(t,e,r){return(r=r||new Float32Array(3))[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}static subtractVectors(t,e,r){return(r=r||new Float32Array(3))[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}static normalize(t,e){e=e||new Float32Array(3);var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return r>1e-5&&(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r),e}static length(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}static cross(t,e,r){return(r=r||new Float32Array(3))[0]=t[1]*e[2]-t[2]*e[1],r[1]=t[2]*e[0]-t[0]*e[2],r[2]=t[0]*e[1]-t[1]*e[0],r}static dot(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}static distanceSq(t,e){const r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return r*r+i*i+n*n}static distance(t,e){return Math.sqrt(d.distanceSq(t,e))}static identity(t){return(t=t||new Float32Array(16))[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static transpose(t,e){return(e=e||new Float32Array(16))[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e}static lookAt(t,e,r,i){i=i||new Float32Array(16);var n=d.normalize(d.subtractVectors(t,e)),a=d.normalize(d.cross(r,n)),o=d.normalize(d.cross(n,a));return i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=n[0],i[9]=n[1],i[10]=n[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}static perspective(t,e,r,i,n){n=n||new Float32Array(16);var a=Math.tan(.5*Math.PI-.5*t),o=1/(r-i);return n[0]=a/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=(r+i)*o,n[11]=-1,n[12]=0,n[13]=0,n[14]=r*i*o*2,n[15]=0,n}static orthographic(t,e,r,i,n,a,o){return(o=o||new Float32Array(16))[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-r),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2/(n-a),o[11]=0,o[12]=(t+e)/(t-e),o[13]=(r+i)/(r-i),o[14]=(n+a)/(n-a),o[15]=1,o}static frustum(t,e,r,i,n,a,o){var s=e-t,c=i-r,h=a-n;return(o=o||new Float32Array(16))[0]=2*n/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*n/c,o[6]=0,o[7]=0,o[8]=(t+e)/s,o[9]=(i+r)/c,o[10]=-(a+n)/h,o[11]=-1,o[12]=0,o[13]=0,o[14]=-2*n*a/h,o[15]=0,o}static translation(t,e,r,i){return(i=i||new Float32Array(16))[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=r,i[15]=1,i}static translate(t,e,r,i,n){n=n||new Float32Array(16);var a=t[0],o=t[1],s=t[2],c=t[3],h=t[4],l=t[5],u=t[6],d=t[7],v=t[8],p=t[9],m=t[10],g=t[11],f=t[12],E=t[13],T=t[14],_=t[15];return t!==n&&(n[0]=a,n[1]=o,n[2]=s,n[3]=c,n[4]=h,n[5]=l,n[6]=u,n[7]=d,n[8]=v,n[9]=p,n[10]=m,n[11]=g),n[12]=a*e+h*r+v*i+f,n[13]=o*e+l*r+p*i+E,n[14]=s*e+u*r+m*i+T,n[15]=c*e+d*r+g*i+_,n}static xRotation(t,e){e=e||new Float32Array(16);var r=Math.cos(t),i=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static xRotate(t,e,r){r=r||new Float32Array(16);var i=t[4],n=t[5],a=t[6],o=t[7],s=t[8],c=t[9],h=t[10],l=t[11],u=Math.cos(e),d=Math.sin(e);return r[4]=u*i+d*s,r[5]=u*n+d*c,r[6]=u*a+d*h,r[7]=u*o+d*l,r[8]=u*s-d*i,r[9]=u*c-d*n,r[10]=u*h-d*a,r[11]=u*l-d*o,t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}static yRotation(t,e){e=e||new Float32Array(16);var r=Math.cos(t),i=Math.sin(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static yRotate(t,e,r){r=r||new Float32Array(16);var i=t[0],n=t[1],a=t[2],o=t[3],s=t[8],c=t[9],h=t[10],l=t[11],u=Math.cos(e),d=Math.sin(e);return r[0]=u*i-d*s,r[1]=u*n-d*c,r[2]=u*a-d*h,r[3]=u*o-d*l,r[8]=u*s+d*i,r[9]=u*c+d*n,r[10]=u*h+d*a,r[11]=u*l+d*o,t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}static zRotation(t,e){e=e||new Float32Array(16);var r=Math.cos(t),i=Math.sin(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}static zRotate(t,e,r){r=r||new Float32Array(16);var i=t[0],n=t[1],a=t[2],o=t[3],s=t[4],c=t[5],h=t[6],l=t[7],u=Math.cos(e),d=Math.sin(e);return r[0]=u*i+d*s,r[1]=u*n+d*c,r[2]=u*a+d*h,r[3]=u*o+d*l,r[4]=u*s-d*i,r[5]=u*c-d*n,r[6]=u*h-d*a,r[7]=u*l-d*o,t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}static axisRotation(t,e,r){r=r||new Float32Array(16);var i=t[0],n=t[1],a=t[2],o=Math.sqrt(i*i+n*n+a*a),s=(i/=o)*i,c=(n/=o)*n,h=(a/=o)*a,l=Math.cos(e),u=Math.sin(e),d=1-l;return r[0]=s+(1-s)*l,r[1]=i*n*d+a*u,r[2]=i*a*d-n*u,r[3]=0,r[4]=i*n*d-a*u,r[5]=c+(1-c)*l,r[6]=n*a*d+i*u,r[7]=0,r[8]=i*a*d+n*u,r[9]=n*a*d-i*u,r[10]=h+(1-h)*l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}static axisRotate(t,e,r,i){i=i||new Float32Array(16);var n=e[0],a=e[1],o=e[2],s=Math.sqrt(n*n+a*a+o*o),c=(n/=s)*n,h=(a/=s)*a,l=(o/=s)*o,u=Math.cos(r),d=Math.sin(r),v=1-u,p=c+(1-c)*u,m=n*a*v+o*d,g=n*o*v-a*d,f=n*a*v-o*d,E=h+(1-h)*u,T=a*o*v+n*d,_=n*o*v+a*d,y=a*o*v-n*d,x=l+(1-l)*u,M=t[0],w=t[1],A=t[2],R=t[3],I=t[4],S=t[5],D=t[6],L=t[7],P=t[8],b=t[9],C=t[10],U=t[11];return i[0]=p*M+m*I+g*P,i[1]=p*w+m*S+g*b,i[2]=p*A+m*D+g*C,i[3]=p*R+m*L+g*U,i[4]=f*M+E*I+T*P,i[5]=f*w+E*S+T*b,i[6]=f*A+E*D+T*C,i[7]=f*R+E*L+T*U,i[8]=_*M+y*I+x*P,i[9]=_*w+y*S+x*b,i[10]=_*A+y*D+x*C,i[11]=_*R+y*L+x*U,t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}static scaling(t,e,r,i){return(i=i||new Float32Array(16))[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=r,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}static scale(t,e,r,i,n){return(n=n||new Float32Array(16))[0]=e*t[0],n[1]=e*t[1],n[2]=e*t[2],n[3]=e*t[3],n[4]=r*t[4],n[5]=r*t[5],n[6]=r*t[6],n[7]=r*t[7],n[8]=i*t[8],n[9]=i*t[9],n[10]=i*t[10],n[11]=i*t[11],t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}static compose(t,e,r,i){i=i||new Float32Array(16);const n=e[0],a=e[1],o=e[2],s=e[3],c=n+n,h=a+a,l=o+o,u=n*c,d=n*h,v=n*l,p=a*h,m=a*l,g=o*l,f=s*c,E=s*h,T=s*l,_=r[0],y=r[1],x=r[2];return i[0]=(1-(p+g))*_,i[1]=(d+T)*_,i[2]=(v-E)*_,i[3]=0,i[4]=(d-T)*y,i[5]=(1-(u+g))*y,i[6]=(m+f)*y,i[7]=0,i[8]=(v+E)*x,i[9]=(m-f)*x,i[10]=(1-(u+p))*x,i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}static quatFromRotationMatrix(t,e){const r=t[0],i=t[4],n=t[8],a=t[1],o=t[5],s=t[9],c=t[2],h=t[6],l=t[10],u=r+o+l;if(u>0){const t=.5/Math.sqrt(u+1);e[3]=.25/t,e[0]=(h-s)*t,e[1]=(n-c)*t,e[2]=(a-i)*t}else if(r>o&&r>l){const t=2*Math.sqrt(1+r-o-l);e[3]=(h-s)/t,e[0]=.25*t,e[1]=(i+a)/t,e[2]=(n+c)/t}else if(o>l){const t=2*Math.sqrt(1+o-r-l);e[3]=(n-c)/t,e[0]=(i+a)/t,e[1]=.25*t,e[2]=(s+h)/t}else{const t=2*Math.sqrt(1+l-r-o);e[3]=(a-i)/t,e[0]=(n+c)/t,e[1]=(s+h)/t,e[2]=.25*t}}static decompose(t,e,r,i){const n=d.length(t.slice(0,3)),a=d.length(t.slice(4,7)),o=d.length(t.slice(8,11));d.determinate(t)<0&&(n=-n),e[0]=t[12],e[1]=t[13],e[2]=t[14];const s=d.copy(t),c=1/n,h=1/a,l=1/o;s[0]*=c,s[1]*=c,s[2]*=c,s[4]*=h,s[5]*=h,s[6]*=h,s[8]*=l,s[9]*=l,s[10]*=l,d.quatFromRotationMatrix(s,r),i[0]=n,i[1]=a,i[2]=o}static determinate(t){var e=t[0],r=t[1],i=t[2],n=t[3],a=t[4],o=t[5],s=t[6],c=t[7],h=t[8],l=t[9],u=t[10],d=t[11],v=t[12],p=t[13],m=t[14],g=t[15],f=u*g,E=m*d,T=s*g,_=m*c,y=s*d,x=u*c,M=i*g,w=m*n,A=i*d,R=u*n,I=i*c,S=s*n;return 1/(e*(f*o+_*l+y*p-(E*o+T*l+x*p))+a*(E*r+M*l+R*p-(f*r+w*l+A*p))+h*(T*r+w*o+I*p-(_*r+M*o+S*p))+v*(x*r+A*o+S*l-(y*r+R*o+I*l)))}static inverse(t,e){e=e||new Float32Array(16);var r=t[0],i=t[1],n=t[2],a=t[3],o=t[4],s=t[5],c=t[6],h=t[7],l=t[8],u=t[9],d=t[10],v=t[11],p=t[12],m=t[13],g=t[14],f=t[15],E=d*f,T=g*v,_=c*f,y=g*h,x=c*v,M=d*h,w=n*f,A=g*a,R=n*v,I=d*a,S=n*h,D=c*a,L=l*m,P=p*u,b=o*m,C=p*s,U=o*u,F=l*s,N=r*m,O=p*i,z=r*u,V=l*i,B=r*s,j=o*i,X=E*s+y*u+x*m-(T*s+_*u+M*m),G=T*i+w*u+I*m-(E*i+A*u+R*m),H=_*i+A*s+S*m-(y*i+w*s+D*m),q=M*i+R*s+D*u-(x*i+I*s+S*u),k=1/(r*X+o*G+l*H+p*q);return e[0]=k*X,e[1]=k*G,e[2]=k*H,e[3]=k*q,e[4]=k*(T*o+_*l+M*p-(E*o+y*l+x*p)),e[5]=k*(E*r+A*l+R*p-(T*r+w*l+I*p)),e[6]=k*(y*r+w*o+D*p-(_*r+A*o+S*p)),e[7]=k*(x*r+I*o+S*l-(M*r+R*o+D*l)),e[8]=k*(L*h+C*v+U*f-(P*h+b*v+F*f)),e[9]=k*(P*a+N*v+V*f-(L*a+O*v+z*f)),e[10]=k*(b*a+O*h+B*f-(C*a+N*h+j*f)),e[11]=k*(F*a+z*h+j*v-(U*a+V*h+B*v)),e[12]=k*(b*d+F*g+P*c-(U*g+L*c+C*d)),e[13]=k*(z*g+L*n+O*d-(N*d+V*g+P*n)),e[14]=k*(N*c+j*g+C*n-(B*g+b*n+O*c)),e[15]=k*(B*d+U*n+V*c-(z*c+j*d+F*n)),e}static transformVector(t,e,r){r=r||new Float32Array(4);for(var i=0;i<4;++i){r[i]=0;for(var n=0;n<4;++n)r[i]+=e[n]*t[4*n+i]}return r}static transformPoint(t,e,r){r=r||new Float32Array(3);var i=e[0],n=e[1],a=e[2],o=i*t[3]+n*t[7]+a*t[11]+t[15];return r[0]=(i*t[0]+n*t[4]+a*t[8]+t[12])/o,r[1]=(i*t[1]+n*t[5]+a*t[9]+t[13])/o,r[2]=(i*t[2]+n*t[6]+a*t[10]+t[14])/o,r}static transformDirection(t,e,r){r=r||new Float32Array(3);var i=e[0],n=e[1],a=e[2];return r[0]=i*t[0]+n*t[4]+a*t[8],r[1]=i*t[1]+n*t[5]+a*t[9],r[2]=i*t[2]+n*t[6]+a*t[10],r}static transformNormal(t,e,r){r=r||new Float32Array(3);var i=d.inverse(t),n=e[0],a=e[1],o=e[2];return r[0]=n*i[0]+a*i[1]+o*i[2],r[1]=n*i[4]+a*i[5]+o*i[6],r[2]=n*i[8]+a*i[9]+o*i[10],r}static copy(t,e){return(e=e||new Float32Array(16))[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}}var v=d;var p=class extends u{constructor(t,e,r,i,n=.1,a=2e6,o=60){super(),this.cameraPosition=t,this.targetPosition=e,this.up=r,this.aspect=i,this.near=n,this.far=a,this.fov=o,this.viewMatrix=this.calculateViewMatrix(this.cameraPosition,this.targetPosition,this.up),this.projectionMatrix=this.calculateProjectionMatrix(this.aspect,this.near,this.far,this.fov),this.viewProjectionMatrix=this.calculateViewProjectionMatrix(this.viewMatrix,this.projectionMatrix)}calculateViewMatrix(t,e,r){const i=v.lookAt(t,e,r);return v.inverse(i)}calculateProjectionMatrix(t,e,r,i){return v.perspective(s.degToRad(i),t,e,r)}calculateViewProjectionMatrix(t,e){return v.multiply(e,t)}calculateVPMatrix(t,e,r,i,n,a,o){const c=v.perspective(s.degToRad(o),i,n,a),h=v.lookAt(t,e,r),l=v.inverse(h);return v.multiply(c,l)}setPosition(t,e,r){this.cameraPosition=[t,e,r],this.update()}getPosition(){return this.cameraPosition}update(){this.viewMatrix=this.calculateViewMatrix(this.cameraPosition,this.targetPosition,this.up),this.projectionMatrix=this.calculateProjectionMatrix(this.aspect,this.near,this.far,this.fov),this.viewProjectionMatrix=this.calculateViewProjectionMatrix(this.viewMatrix,this.projectionMatrix)}getViewMatrix(){return this.viewMatrix}getProjectionMatrix(){this.projectionMatrix}getViewProjectionMatrix(){return this.viewProjectionMatrix}};var m=class{constructor(t){this.map=t,this.init(),this.initMouseEvent(),this.initWindowEvent()}init(){this.downEvent=null,this.upEvent=null,this.THRESHOLD_DISTANCE_SINGLE=5,this.THRESHOLD_TIME_DOUBLE=500,this.preDownTime=Number.MIN_SAFE_INTEGER,this.downTime=Number.MIN_SAFE_INTEGER,this.isDBClick=!1}initMouseEvent(){const t=this.map.container;t.addEventListener("mousedown",t=>{this.dispatchEvent({type:"mousedown",originEvent:t}),this.downEvent=t,this.preDownTime=this.downTime,this.downTime=(new Date).getTime(),this.downTime-this.preDownTime<this.THRESHOLD_TIME_DOUBLE&&(this.isDBClick=!0)},!1),t.addEventListener("mousemove",t=>{if(this.dispatchEvent({type:"mousemove",originEvent:t}),this.downEvent)switch(this.downEvent.button){case 0:this.dispatchEvent({type:"dragleft",originEvent:t});break;case 1:break;case 2:this.dispatchEvent({type:"dragright",originEvent:t})}},!1),t.addEventListener("mouseup",t=>{if(this.dispatchEvent({type:"mouseup",originEvent:t}),!this.downEvent)return;const e=this.distanceSqBetweenEvents(this.downEvent,t);switch(t.button){case 0:e<this.THRESHOLD_DISTANCE_SINGLE&&(this.isDBClick?this.dispatchEvent({type:"dbclick",originEvent:t}):this.dispatchEvent({type:"clickleft",originEvent:t}));break;case 1:break;case 2:e<this.THRESHOLD_DISTANCE_SINGLE&&this.dispatchEvent({type:"clickright",originEvent:t})}this.isDBClick=!1,this.downEvent=null},!1),t.addEventListener("mousewheel",t=>{this.dispatchEvent({type:"zoom",originEvent:t})},{passive:!0}),t.addEventListener("DOMMouseScroll",t=>{this.dispatchEvent({type:"zoom",originEvent:t})})}initWindowEvent(){window.addEventListener("resize",t=>{this.dispatchEvent({type:"resize",originEvent:t})})}setMap(t){this.map=t}distanceSqBetweenEvents(t,e){return Math.pow(e.clientX-t.clientX,2)+Math.pow(e.clientY-t.clientY,2)}addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const r=this._listeners;void 0===r[t]&&(r[t]=[]),-1===r[t].indexOf(e)&&r[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const r=this._listeners;return void 0!==r[t]&&-1!==r[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const r=this._listeners[t];if(void 0!==r){const t=r.indexOf(e);-1!==t&&r.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const r=e.slice(0);for(let e=0,i=r.length;e<i;e++)r[e].call(this,t)}}};var g=class{constructor(t,e){if(this.rootContainer="[object String]"===Object.prototype.toString.call(t)?document.getElementById(t):t,this.container=document.createElement("div"),this.container.className="container",this.container.style.position="absolute",this.container.style.overflow="hidden",this.container.style.width="100%",this.container.style.height="100%",this.container.style.zIndex="0",this.rootContainer.appendChild(this.container),this.canvas=document.createElement("canvas"),this.canvas.className="container",this.canvas.style.position="absolute",this.canvas.style.overflow="hidden",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.zIndex="0",this.container.appendChild(this.canvas),this.eventDispatcher=new m(this),this.layers=[],this.controls=[],this.center=e.center,this.level=e.level,this.gl=this.canvas.getContext("webgl2"),!this.gl)return void console.warn("不支持webgl2！");this.earth=new l("http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineCommunityENG/MapServer/tile/0/0/0"),this.earth.setMap(this);const r=this.earth.wgs84ToCartesian(...this.center,this.earth.EARTH_RADIUS);this.camera=new p(r,[0,0,0],[0,0,1],1),this.viewProjectionMatrix=this.camera.getViewProjectionMatrix(),this.radian=0,this.setCenter(this.center,this.level)}addControl(t){this.controls.push(t)}addLayer(t){this.layers.push(t)}setCenter(t,e=this.getLevel()){t[0]===this.center[0]&&t[1]===this.center[1]&&e===this.getLevel()||(this.center=t,this.level=e,this.update())}getCenter(){return this.center}getLevel(){return this.level}setLevel(t){t<0||this.setCenter(this.center,t)}update(){const t=2*this.earth.EARTH_RADIUS,e=this.level,r=t/Math.pow(2,e),i=this.earth.wgs84ToCartesian(this.center[0],this.center[1],r);this.camera.setPosition(...i),this.camera.aspect=this.gl.canvas.width/this.gl.canvas.height,this.layers.forEach(t=>{t.setCenter(this.center,e)})}redraw(){const t=this.gl;s.resizeCanvasToDisplaySize(t.canvas);this.update(),requestAnimationFrame(this.redraw.bind(this)),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(1,1,1,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),this.earth.redraw(),this.layers.forEach(t=>{t.redraw()})}};var f=class{constructor(){this.isBaseLayer=!1}addFeature(t){}removeFeature(t){}setMap(t){this.map=t,this.map.addLayer(this)}setLevel(t){}redraw(){}};var E=class extends f{constructor(t,e,r){super(),this.url=t,this.name=e,this.option=r,this.store=new Map,this.curScreen={}}setMap(t){super.setMap(t),this.program=new h(this.map.gl),this.center=this.map.getCenter(),this.level=this.map.getLevel(),this.initScreen()}setUrl(t){}_tileOnLoad(){}_tileOnError(){}_tileOnRemove(){}_abortLoading(){}_removeTile(){}_tileReady(){}_getSubdomain(){}initScreen(){this.curScreen=this.calculateTiles();const{level:t,rowStart:e,rowEnd:r,colStart:i,colEnd:n}=this.curScreen;for(let a=e;a<=r;a++)for(let e=i;e<=n;e++){const{realRow:r,realCol:i}=this.getRealKey(t,a,e),n=t+"-"+r+"-"+i;if(!this.store.get(n)){const e=this.createTile(t,r,i);this.store.set(n,e)}}}calculateTiles(){const t=this.option.origin,e=this.option.tileSize,r=this.level,i=s.lonLatToSphericalMercator(this.center),n=this.option.resolutions[r],a=[this.map.gl.canvas.width,this.map.gl.canvas.height],o=i[0]-n*a[0]/2,c=i[0]+n*a[0]/2,h=Math.floor((o-t[0])/(n*e[0])),l=Math.ceil((c-t[0])/(n*e[0])),u=i[1]+n*a[1]/2,d=i[1]-n*a[1]/2;return{level:r,rowStart:Math.floor((t[1]-u)/(n*e[1])),rowEnd:Math.ceil((t[1]-d)/(n*e[1])),colStart:h,colEnd:l}}createTile(t,e,r){const i=this.map.gl,n=this.getTileUrl(t,e,r),a=this._getTileCoords(t,e,r),o=this.program.createVAOInfo();i.bindVertexArray(o.vao),this.program.attributes.forEach(t=>{this.program.createBufferData(new t.arrayType(a[t.name]),i.STATIC_DRAW,t)}),o.count=a.a_position.length/3,o.indexCount=a.index.length;const s=this.program.createTextureInfo(n);return i.bindVertexArray(null),{vaoInfo:o,textureInfo:s,data:a}}getTileUrl(t,e,r){return this.url.replace("{x}",r).replace("{y}",e).replace("{l}",t)}_getTileCoords(t,e,r){const i=this.option.origin,n=this.option.tileSize,a=this.option.resolutions[t],o=this.map.earth.baseLevel,c=a*n[0],h=a*n[1],l=c*r+i[0],u=i[1]-h*e,d=l+c,v=u-h,p=s.sphericalMercatorToLonLat([l,u,0]),m=s.sphericalMercatorToLonLat([d,u,0]),g=s.sphericalMercatorToLonLat([l,v,0]),f=(s.sphericalMercatorToLonLat([d,v,0]),o-t),E=f>=0?Math.pow(2,f):1;return s.getTileInfo(p[0],m[0],p[1],g[1],E,E)}setCenter(t,e){this.level;this.center=t,this.level=e+2,this.initScreen()}redraw(){const t=this.map.gl;t.disable(t.DEPTH_TEST);this.program;t.useProgram(this.program.program),this.program.uniforms[0].data=this.map.camera.getViewProjectionMatrix(),this.program.uniforms.forEach(e=>{t[e.functionType](e.location,e.normalize,e.data)});const{level:e,rowStart:r,rowEnd:i,colStart:n,colEnd:a}=this.curScreen,o=this.program.uniforms[1].location;for(let s=r;s<=i;s++)for(let r=n;r<=a;r++){const{realRow:i,realCol:n}=this.getRealKey(e,s,r),a=e+"-"+i+"-"+n,{textureInfo:c,vaoInfo:h}=this.store.get(a);if(c.update){t.bindVertexArray(h.vao);const e=1;t.uniform1i(o,e),t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,c.texture),t.drawElements(t.TRIANGLES,h.indexCount,t.UNSIGNED_INT,h.offset),t.bindVertexArray(null)}}t.useProgram(null)}getRealKey(t,e,r){let i=0,n=0;if(0===t)i=0,n=0;else if(1===t)e>=0&&(i=e%2==1?1:0),e<0&&(i=-e%2==1?1:0),r>=0&&(n=r%2==1?1:0),r<0&&(n=-r%2==1?1:0);else{const a=Math.pow(2,t)-1;if(i=e,i<0&&(i=-i),i>a){const t=2*a,e=i%t;i=e>a?t-e:e}for(n=r;n>a;)n-=a+1;for(;n<0;)n=n+a+1}return{realRow:i,realCol:n}}};var T=class{constructor(){this.map=null}setMap(t){this.map=t,this.map.addControl(this)}};var _=class extends T{constructor(){super(),this.drag=s.throttle(this.onDrag.bind(this),50),this.zoom=s.throttle(this.onZoom.bind(this),50)}setMap(t){super.setMap(t),this.eventDispatcher=this.map.eventDispatcher,this.enable()}enable(){const t=this.eventDispatcher;t.addEventListener("dragleft",this.drag),t.addEventListener("zoom",this.zoom)}disable(){const t=this.eventDispatcher;t.removeEventListener("dragleft",this.drag),t.removeEventListener("zoom",this.drag)}onDrag(t){const e=this.map.getCenter(),r=t.originEvent,i=r.movementX,n=r.movementY,a=this.map.getLevel(),o=360/Math.pow(2,a+2)/256,s=2*o*i,c=o*n;let h=e[0]-s,l=e[1]+c;for(;h>180;)h-=360;for(;h<-180;)h+=360;for(;l>90;)l=180-l;for(;l<-90;)l=-l-180;this.map.setCenter([h,l])}onZoom(t){const e=this.map.getCenter();if(t.originEvent.wheelDelta>0||t.originEvent.detail<0){const t=this.map.getLevel()+1;t>=0&&this.map.setCenter(e,t)}else{const t=this.map.getLevel()-1;t>=0&&this.map.setCenter(e,t)}}testLonLatToCar(t,e,r){const i=this.map.earth.RADIUS,n=i,a=(i+n)*Math.sin(t[1]+r);return[(i+n)*Math.cos(t[1]+r)*Math.cos(t[0]+e),(i+n)*Math.cos(t[1]+r)*Math.sin(t[0]+e),a]}update(){}};document.body.appendChild(function(){var t=document.createElement("div");t.style.position="absolute",t.style.overflow="hidden",t.style.width="100%",t.style.height="100%";const e=new g(t,{center:[120,30],level:1});return new E("http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineCommunityENG/MapServer/tile/{l}/{y}/{x}","ImageLayer",{tileSize:[256,256],crs:"epsg:3857",origin:[-20037508.342787,20037508.342787],resolutions:[156543.03392800014,78271.51696399994,39135.75848200009,19567.87924099992,9783.93962049996,4891.96981024998,2445.98490512499,1222.992452562495,611.4962262813797,305.74811314055756,152.87405657041106,76.43702828507324,38.21851414253662,19.10925707126831,9.554628535634155,4.77731426794937,2.388657133974685,1.1943285668550503,.5971642835598172,.29858214164761665],imgType:"png"}).setMap(e),(new _).setMap(e),e.redraw(),window.map=e,t}()),function t(){const e=map.getCenter();e[0]=e[0]+.2,map.setCenter(e),requestAnimationFrame(t)}()}]);
//# sourceMappingURL=main.js.map